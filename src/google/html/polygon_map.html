<!DOCTYPE html>
<html>
<head>
    <title>Multi-region editor</title>

    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <script
            src="https://maps.googleapis.com/maps/api/js?key=__API_KEY__&callback=initMap"
            async defer>
    </script>

    <style>
        #map {
            width: 100vw;
            height: 100vh;
        }

        #confirmOverlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-family: sans-serif;
        }

        #confirmBox {
            background: #ffffff;
            padding: 16px 20px;
            border-radius: 6px;
            min-width: 220px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.25);
        }

        #confirmButtons {
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }
    </style>
</head>

<body>

<div id="map"></div>

<div id="confirmOverlay">
    <div id="confirmBox">
        <p id="confirmText">Delete region?</p>
        <div id="confirmButtons">
            <button id="confirmYes">Delete</button>
            <button id="confirmNo">Cancel</button>
        </div>
    </div>
</div>

<script>
    let map;
    let bridge = null;

    let regions = [];
    let activeRegion = null;

    /* ---------- confirm ---------- */

    let confirmCallback = null;

    function showConfirm(text, onYes) {
        confirmCallback = onYes;
        document.getElementById("confirmText").textContent = text;
        document.getElementById("confirmOverlay").style.display = "flex";
    }

    function hideConfirm() {
        confirmCallback = null;
        document.getElementById("confirmOverlay").style.display = "none";
    }

    document.getElementById("confirmYes").onclick = () => {
        if (confirmCallback) confirmCallback();
        hideConfirm();
    };

    document.getElementById("confirmNo").onclick = hideConfirm;

    /* ---------- C++ notification ---------- */

    function notifyCpp() {
        if (!bridge) return;

        const data = regions
            .filter(r => r.closed)
            .map(r => r.points);

        bridge.onMapChanged(JSON.stringify(data));
    }

    /* ---------- regions ---------- */

    function createRegion(closed = false) {
        const r = {
            points: [],
            markers: [],
            polyline: null,
            polygon: null,
            closed
        };
        regions.push(r);
        if (!closed) activeRegion = r;
        return r;
    }

    function redrawRegion(r) {
        if (r.polyline) r.polyline.setMap(null);
        if (r.polygon) r.polygon.setMap(null);

        if (r.points.length < 2) return;

        if (!r.closed) {
            r.polyline = new google.maps.Polyline({
                map,
                path: r.points,
                strokeColor: "#0f9fea",
                strokeWeight: 2
            });
        } else {
            r.polygon = new google.maps.Polygon({
                map,
                paths: r.points,
                strokeColor: "#0f9fea",
                strokeWeight: 2,
                fillColor: "#0f9fea",
                fillOpacity: 0.25
            });

            r.polygon.addListener("rightclick", () => {
                showConfirm("Delete region?", () => removeRegion(r));
            });
        }
    }

    function removeRegion(r) {
        r.markers.forEach(m => m.setMap(null));
        if (r.polyline) r.polyline.setMap(null);
        if (r.polygon) r.polygon.setMap(null);
        regions = regions.filter(x => x !== r);
        if (activeRegion === r) activeRegion = null;
        notifyCpp();
    }

    function clearAllRegions() {
        regions.forEach(r => {
            r.markers.forEach(m => m.setMap(null));
            if (r.polyline) r.polyline.setMap(null);
            if (r.polygon) r.polygon.setMap(null);
        });
        regions = [];
        activeRegion = null;
    }

    /* ---------- markers ---------- */

    function createMarker(r, pos, index) {
        const m = new google.maps.Marker({
            map,
            position: pos,
            draggable: true
        });

        m.addListener("drag", () => {
            r.points[index] = {
                lat: m.getPosition().lat(),
                lng: m.getPosition().lng()
            };
            redrawRegion(r);
        });

        m.addListener("dragend", () => {
            if (r.closed) notifyCpp();
        });

        m.addListener("click", () => {
            if (index === 0 && r.points.length >= 3 && !r.closed) {
                r.closed = true;
                activeRegion = null;
                redrawRegion(r);
                notifyCpp();
            }
        });

        return m;
    }

    function addPoint(r, lat, lng) {
        const pos = { lat, lng };
        const idx = r.points.length;
        r.points.push(pos);
        r.markers.push(createMarker(r, pos, idx));
        redrawRegion(r);
    }

    /* ---------- C++ â†’ JS ENTRY POINT ---------- */
    /* NOTE: receives a JS ARRAY, not a string */

    function loadMapFromJson(data) {
        if (!Array.isArray(data)) {
            console.error("loadMapFromJson: expected array, got", data);
            return;
        }

        clearAllRegions();

        const bounds = new google.maps.LatLngBounds();

        data.forEach(poly => {
            if (!Array.isArray(poly) || poly.length < 3) return;

            const r = createRegion(true);

            poly.forEach(p => {
                if (typeof p.lat !== "number" || typeof p.lng !== "number") return;
                r.points.push({ lat: p.lat, lng: p.lng });
                bounds.extend(p);
            });

            r.points.forEach((p, i) => {
                r.markers.push(createMarker(r, p, i));
            });

            redrawRegion(r);
        });

        if (!bounds.isEmpty())
            map.fitBounds(bounds);
    }

    /* ---------- map ---------- */

    function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
            center: { __CENTER__ },
            zoom: 6,
            disableDefaultUI: true
        });

        new QWebChannel(qt.webChannelTransport, channel => {
            bridge = channel.objects.bridge;
        });

        map.addListener("click", e => {
            if (!activeRegion) createRegion();
            addPoint(activeRegion, e.latLng.lat(), e.latLng.lng());
        });
    }
</script>

</body>
</html>
